# Frontend Dockerfile for Gradio interface
FROM python:3.11-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV GRADIO_SERVER_NAME=0.0.0.0
ENV GRADIO_SERVER_PORT=7860

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements
COPY requirements.docker.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.docker.txt

# Copy application files
COPY gradio_app.py .
COPY pres_images/ ./pres_images/

# Create startup script
RUN echo '#!/bin/bash\n\
echo "Waiting for vLLM backend to be ready..."\n\
while ! curl -f http://backend:8801/v1/models > /dev/null 2>&1; do\n\
  echo "Backend not ready yet, waiting..."\n\
  sleep 5\n\
done\n\
echo "Backend is ready! Starting Gradio frontend..."\n\
python gradio_app.py\n\
' > start_frontend.sh && chmod +x start_frontend.sh

# Expose port
EXPOSE 7860

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:7860 || exit 1

# Start Gradio frontend
CMD ["./start_frontend.sh"]
